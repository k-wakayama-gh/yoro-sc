<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/base.css">
    <title>パスワード再設定</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .container {
            max-width: 400px;
            width: 100%;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
        }
        input, button, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        textarea {
            resize: none;
            height: 80px; /* 固定高さ */
        }
        .message {
            margin-top: 10px;
            padding: 10px;
            font-weight: bold;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    {% include "header.html" %}

    {% include "login.html" %}

    <div class="container">
        <h1>Password Reset</h1>

        <!-- パスワードリセットリンクのリクエスト -->
        <input id="username" type="text" placeholder="Enter username">
        <button onclick="requestResetLink()">Request Reset Link</button>

        <hr>

        <textarea id="resetLink" readonly placeholder="Reset link will appear here..."></textarea>
        <button onclick="copyToClipboard()">Copy to Clipboard</button>

        <hr>

        <!-- 新しいパスワードの入力 -->
        <input id="token" type="text" placeholder="Enter reset token">
        <input id="newPassword" type="password" placeholder="Enter new password">
        <button onclick="resetPassword()">Reset Password</button>

        <p id="message" class="message"></p>
    </div>

    <script src="/static/js/base.js"></script>
    <script src="/static/js/login.js"></script>

    <script>
        // メッセージ表示用関数
        function showMessage(text, isSuccess = true) {
            const messageElement = document.getElementById("message");
            messageElement.textContent = text;
            messageElement.className = "message " + (isSuccess ? "success" : "error");
        }

        // URL からトークンを取得
        function getQueryParam(param) {
            const params = new URLSearchParams(window.location.search);
            return params.get(param);
        }

        document.addEventListener("DOMContentLoaded", function() {
            // URL からトークンを取得してセット
            const tokenFromUrl = getQueryParam("token");
            if (tokenFromUrl) {
                document.getElementById("token").value = tokenFromUrl;
            }
        });

        // パスワードリセットリンクをリクエスト
        async function requestResetLink() {
            const user_token = loadAccessToken();
            const username = document.getElementById("username").value;
            if (!username) {
                showMessage("Username is required.", false);
                return;
            }

            try {
                const res = await fetch("/request-password-reset/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + user_token},
                    body: JSON.stringify({ username })
                });

                const data = await res.json();
                if (res.ok) {
                    showMessage("Success! Reset link sent.");
                    document.getElementById("resetLink").value = data.reset_link;
                } else {
                    showMessage(data.message || "Failed to request reset link.", false);
                }
            } catch (error) {
                showMessage("Network error. Please try again.", false);
            }
        }

        function copyToClipboard() {
            const resetLinkTextarea = document.getElementById("resetLink");
            resetLinkTextarea.select();  // テキストを選択
            document.execCommand('copy');  // クリップボードにコピー
            document.getElementById("message").textContent = "Link copied to clipboard!";
        }

        // パスワードをリセット
        async function resetPassword() {
            const token = document.getElementById("token").value;
            const newPassword = document.getElementById("newPassword").value;

            if (!token || !newPassword) {
                showMessage("Token and password are required.", false);
                return;
            }

            try {
                const res = await fetch("/reset-password/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ token, new_password: newPassword })
                });

                const data = await res.json();
                if (res.ok) {
                    showMessage("Password reset successful! You can now log in.");
                } else {
                    showMessage(data.message || "Failed to reset password.", false);
                }
            } catch (error) {
                showMessage("Network error. Please try again.", false);
            }
        }
    </script>
</body>
</html>
